name: NBA/NCAA Data Update

on:
  schedule:
    - cron: '0 */2 * * *' # Every 2 hours
  workflow_dispatch: # Allows manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Data Update and Push to Supabase
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # 1. Fetch Reference Stats (Essential for engine to match teams)
          echo "Fetching NCAA Reference Data..."
          python -m ncaa.fetch_barttorvik
          python -m ncaa.data_fetcher
          python -m ncaa.v1_2.populate # Ensure D1 matchups are refreshed

          # 2. Fetch NBA Core Data (Retry loop for flakiness)
          echo "Fetching NBA Schedule and Player Stats..."
          for i in {1..2}; do 
            python -m nba.fetch_nba_schedule && \
            python -m nba.fetch_nba_player_stats && break || sleep 10
            echo "NBA Data fetch failed, retrying ($i/2)..."
          done
          
          # 3. Generate Predictions and Archive History
          echo "Pushing Predictions to Supabase..."
          python core/supabase_pusher.py
          
          # 4. Run Performance Audit (Grades yesterday's games)
          echo "Running Performance Audit Engine..."
          python core/audit_engine.py --days 1

      - name: Debug Fetched Data (On Failure or Success)
        if: always()
        run: |
          echo "Listing data directory..."
          ls -R data/ || echo "No data directory found"
          echo "Matchup Files Content Summary:"
          cat data/nba_matchups.json 2>/dev/null | head -n 20 || echo "No NBA matchups"
          cat data/ncaa_matchups.json 2>/dev/null | head -n 20 || echo "No NCAA matchups"
          cat data/euro_matchups.json 2>/dev/null | head -n 20 || echo "No EURO matchups"
          cat data/acb_matchups.json 2>/dev/null | head -n 20 || echo "No ACB matchups"

