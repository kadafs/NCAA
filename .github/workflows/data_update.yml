name: NBA/NCAA Data Update

on:
  schedule:
    - cron: '0 */2 * * *' # Every 2 hours
  workflow_dispatch: # Allows manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Data Update and Push to Supabase
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # 1. Fetch Reference Stats (Essential for engine to match teams)
          echo "Fetching NCAA Stats (BartTorvik)..."
          python -m ncaa.fetch_barttorvik
          
          echo "Fetching NCAA Consolidated Standings..."
          python -m ncaa.data_fetcher

          # 2. Fetch NBA Schedule/Odds (Retry loop for flakiness)
          echo "Fetching NBA Schedule..."
          for i in {1..3}; do 
            python -m nba.fetch_nba_schedule && break || sleep 10
            echo "NBA Schedule fetch failed, retrying ($i/3)..."
          done
          
          echo "Fetching NBA Stats..."
          for i in {1..3}; do
            python -m nba.fetch_nba_stats && break || sleep 10
            echo "NBA Stats fetch failed, retrying ($i/3)..."
          done
          
          # 3. Fetch European Schedules
          python -m euro.fetch_euro_schedule
          python -m eurocup.fetch_eurocup_schedule
          
          # 4. Fetch NBL/ACB
          python -m nbl.fetch_nbl_schedule
          python -m acb.fetch_acb_schedule
          
          # 5. Generate and Push Predictions
          python core/supabase_pusher.py

      - name: Debug Fetched Data (On Failure or Success)
        if: always()
        run: |
          echo "Listing data directory..."
          ls -R data/ || echo "No data directory found"
          echo "Matchup Files Content Summary:"
          cat data/nba_matchups.json 2>/dev/null | head -n 20 || echo "No NBA matchups"
          cat data/ncaa_matchups.json 2>/dev/null | head -n 20 || echo "No NCAA matchups"
          cat data/euro_matchups.json 2>/dev/null | head -n 20 || echo "No EURO matchups"
          cat data/acb_matchups.json 2>/dev/null | head -n 20 || echo "No ACB matchups"

