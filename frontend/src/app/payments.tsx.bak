'use client';

import React, { useState } from 'react';
import { parseEther } from 'viem';
import { useSendTransaction, useWaitForTransactionReceipt } from 'wagmi';
import { Loader2, CheckCircle2, AlertCircle } from 'lucide-react';

interface PaymentProps {
    onSuccess: (hash: string) => void;
    amount?: string; // in ETH/Core currency
}

// NCAA Analytics Platform Treasury Address (Example)
const TREASURY_ADDRESS = '0x742d35Cc6634C0532925a3b844Bc454e4438f44e';

export function CryptoPayment({ onSuccess, amount = "0.05" }: PaymentProps) {
    const { data: hash, error, isPending, sendTransaction } = useSendTransaction();
    const [isVerifying, setIsVerifying] = useState(false);

    const { isLoading: isConfirming, isSuccess: isConfirmed } =
        useWaitForTransactionReceipt({
            hash,
        });

    React.useEffect(() => {
        if (isConfirmed && hash) {
            onSuccess(hash);
        }
    }, [isConfirmed, hash, onSuccess]);

    const handlePayment = () => {
        sendTransaction({
            to: TREASURY_ADDRESS,
            value: parseEther(amount),
        });
    };

    return (
        <div className="space-y-4 w-full">
            <button
                onClick={handlePayment}
                disabled={isPending || isConfirming}
                className="w-full px-8 py-3 bg-accent-orange text-white rounded-xl font-bold shadow-lg shadow-accent-orange/30 hover:scale-105 transition-all disabled:opacity-50 disabled:hover:scale-100 flex items-center justify-center gap-2"
            >
                {isPending || isConfirming ? (
                    <>
                        <Loader2 className="w-5 h-5 animate-spin" />
                        {isPending ? "Waiting for Wallet..." : "Confirming on Chain..."}
                    </>
                ) : (
                    "Unlock Lifetime Pro Access"
                )}
            </button>

            {error && (
                <div className="flex items-center gap-2 text-red-400 text-xs mt-2 bg-red-400/10 p-2 rounded-lg border border-red-400/20">
                    <AlertCircle className="w-4 h-4" />
                    <span>Payment failed: {(error as any).shortMessage || error.message}</span>
                </div>
            )}

            {isConfirmed && (
                <div className="flex items-center gap-2 text-green-400 text-xs mt-2 bg-green-400/10 p-3 rounded-lg border border-green-400/20">
                    <CheckCircle2 className="w-4 h-4" />
                    <span>Payment Successful! Access Granted.</span>
                </div>
            )}
        </div>
    );
}
